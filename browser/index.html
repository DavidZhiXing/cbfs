<html>
  <head>
    <title>CBFS - File Browser</title>
    <script type="text/javascript" src="js/jquery.min.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/jquery.hotkeys.js"></script>
    <script type="text/javascript" src="js/jquery.jstree.js"></script>
  </head>
  <body>


<h3>CBFS - File Browser</h3>

<div id="files" class="files" style="height:600px; width:66%; float: left"></div>
<div id="info" class="info" style="height:600px; width:33%; float: right; font-family: monospace; white-space: pre;"></div>

<!-- JavaScript neccessary for the tree -->
<script type="text/javascript" class="source below">
$(function () {

$("#files").jstree({
        "themes": {
            "theme": "classic",
            "dots": true,
            "icons": true
        },
        "plugins" : ["themes", "json_data", "ui","types"],
        "json_data" : {
            "data" : [
                { 
                    "data" : "/", 
                    "state" : "closed",
                    "attr" : { "id" : "/", "rel": "drive" }
                }
            ],
            "ajax" : {
                "type": 'GET',
                "url": function (node) {
                    var nodeId = "";
                    var url = ""
                    if (node == -1)
                    {
                        url = "/.cbfs/list/?includeMeta=true";
                    }
                    else
                    {
                        nodeId = node.attr('id');
                        url = "/.cbfs/list" + nodeId + "?includeMeta=true";
                    }

                    return url;
                },
                "success": function(data, textStatus, jqXHR) {
                    
                    //build the object jstree wants
                    response = [];
                    
                    for(var j in data.dirs) {
                        var dir = data.dirs[i];
                        var prefix = data.path;
                        if(prefix === "/") {
                            prefix = "";
                        }
                        response.push({ "data": j, "state": "closed", "attr": { "id": prefix + "/" + j, "rel": "folder" } })
                    }
                    
                    for(var i in data.files) {
                      var file = data.files[i];
                      response.push({ "data": i, "attr": { "id": prefix + "/" + i, "rel": "default" }, "meta": file });
                    }
                    
                    return response;
                    
                },
                "error": function(y) {
                    console.log("in error with");
                    console.log(y);
                }
            }
        },
        "types" : {
            // I set both options to -2, as I do not need depth and children count checking
            // Those two checks may slow jstree a lot, so use only when needed
            "max_depth" : -2,
            "max_children" : -2,
            // I want only `drive` nodes to be root nodes 
            // This will prevent moving or creating any other type as a root node
            "valid_children" : [ "drive" ],
            "types" : {
                // The default type
                "default" : {
                    // I want this type to have no children (so only leaf nodes)
                    // In my case - those are files
                    "valid_children" : "none",
                    // If we specify an icon for the default type it WILL OVERRIDE the theme icons
                    "icon" : {
                        "image" : "./file.png"
                    }
                },
                // The `folder` type
                "folder" : {
                    // can have files and other folders inside of it, but NOT `drive` nodes
                    "valid_children" : [ "default", "folder" ],
                    "icon" : {
                        "image" : "./folder.png"
                    }
                },
                // The `drive` nodes 
                "drive" : {
                    // can have files and folders inside, but NOT other `drive` nodes
                    "valid_children" : [ "default", "folder" ],
                    "icon" : {
                        "image" : "./root.png"
                    },
                    // those prevent the functions with the same name to be used on `drive` nodes
                    // internally the `before` event is used
                    "start_drag" : false,
                    "move_node" : false,
                    "delete_node" : false,
                    "remove" : false
                }
            }
        }
    })
    .bind("select_node.jstree", function (event, data) {
            var node_id = $(this).jstree('get_selected').attr('id');
            // do a HEAD request and set the contents of info
            gethead = $.ajax({
                type: "HEAD",
                async: true,
                url: node_id,
                success: function(message,text,response){
                    $('#info').text(gethead.getAllResponseHeaders());
                }
            });
        }
    );
});
</script>


  </body>
</html>
